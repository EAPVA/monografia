\chapter{Histogramas de gradientes orientados}

Neste capítulo são primeiramente definidos alguns conceitos básicos e então
o algoritmo implementado nesse projeto é apresentado, o
\sigla{HOG}{Histogram of Oriented Gradients} (\emph{Histogram of Oriented
Gradients}) \cite{dalal2005histograms}, um descritor de
imagens que representa distribuição local das orientações dos gradientes.

\section{Definições}

Aqui são apresentadas as definições usadas no trabalho de imagem, \emph{pixel}
e gradiente de imagem.

\subsection{Imagem}

Para os propósitos desse trabalho \emph{imagem} é definida como uma matriz
bidimensional $I$, sendo que $I[x,y]$ representa o \emph{pixel} contido na
linha $y$ e coluna $x$ da matriz. Para respeitar a convenção normalmente
utilizada, os índices $x$ e $y$ iniciarão em $0$ e o \emph{pixel} $I[0,0]$ será
o canto superior esquerdo da imagem.

\subsection{\emph{Pixel}}

Cada elemento $I[x,y]$ de uma imagem é denominado de \emph{pixel}, sendo que
este pode conter informações de um ou mais \emph{canais de cor}. Neste
trabalho, serão usadas imagens em escala de cinza, contendo apenas um canal, e
imagens coloridas RGB, contendo os canais de cor vermelho, verde e azul.

\section{Gradientes de Imagem}

Para uma imagem em escala de cinza $I$, o gradiente de imagem é uma matriz $G$, 
com as mesmas dimensões de $I$, onde cada ponto $G[x,y]$ representa a variação 
de luminosidade que ocorre em $I[x,y]$. Como a variação é bidimensional, cada
ponto do gradiente de imagem será um vetor de duas dimensões, podendo ser
representado tanto na forma cartesiana quanto polar. Com base nisso, temos as
seguintes definições:

\emph{Gradiente horizontal} de uma imagem $I$ é o componente horizontal de $G$,
  sendo denotado por $G_x$ e calculado seguindo a equação
  \ref{eq:good_dx}:

\begin{equation} \label{eq:good_dx}
G_x[x,y] = I[x+1,y] - I[x-1,y]
\end{equation}

\emph{Gradiente vertical} de uma imagem $I$ é o componente vertical de $G$,
  sendo denotado por $G_y$ e calculado seguindo a equação
  \ref{eq:good_dy}:

\begin{equation} \label{eq:good_dy}
  G_y[x,y] = I[x,y+1]- I[x,y-1]
\end{equation}

\emph{Magnitude de gradiente} de uma imagem $I$ é a magnitude de $G$,
  sendo denotada por $G_{\rho}$ e calculada seguindo a equação
  \ref{eq:good_drho}:

\begin{equation} \label{eq:good_drho}
G_{\rho}[x,y] = \sqrt{G_x[x,y]^2 + G_y[x,y]^2}
\end{equation}

\emph{Orientação de gradiente} de uma imagem $I$ é a orientação (ou fase) de 
$G$, sendo denotada por $G_{\theta}$ e calculada seguindo a equação
  \ref{eq:good_dtheta}:

\begin{equation} \label{eq:good_dtheta}
G_{\theta}[x,y] = \arctan \left( {{G_y[x,y]} \over {G_x[x,y]}} \right)
\end{equation}

A magnitude do gradiente de um \emph{pixel} terá valores próximos de zero em
regiões homogêneas da imagem e valores diferentes de zero nas regiões de
transição de intensidade, ou seja, nas regiões de borda.

A figura \ref{fig:gradients} demonstra exemplos de gradientes obtidos para uma
imagem (normalizando os valores de gradiente para valores válidos para uma
        imagem).

TODO: criar figuras de exemplo para colocar aqui.

Existem várias maneiras de obter o gradiente para uma imagem colorida. Será
utilizada a mesma escolhida em
\cite{dalal2005histograms}. Para cada \emph{pixel} será
calculado o gradiente de cada canal de cor e será escolhido o  que tiver a
maior magnitude.

\section{Histogram of Oriented Gradients - HOG}

O descritor de características HOG, descrito em \cite{dalal2005histograms}, 
  é composto por
diversos histogramas das orientações dos gradientes da imagem, calculados em 
uma partição da imagem em diferentes regiões, chamadas de \emph{células}.

O cálculo do HOG é dividido em uma série de etapas: normalização de cor da 
imagem, cálculo dos gradientes, cálculo dos histogramas e normalização de 
contraste local.

\subsection{Normalização}

TODO

\subsection{Cálculo dos gradientes}

Para cada cada um dos três canais de cor da imagem, o gradiente horizontal e o 
gradiente vertical 
são calculados, e, a partir destes, são calculadas a magnitude e a orientação
de gradiente. Para cada \emph{pixel}, são armazenadas a magnitude e orientação
do canal de cor que tiver a maior magnitude naquele \emph{pixel}.

\subsection{Cálculo dos Histogramas}

A região a ser descrita (ou, de maneira equivalente, as matrizes de magnitude e
                         orientação de gradiente) 
é particionada em uma malha de células de mesmo 
tamanho, e um histograma é calculado para cada célula, como demonstra a figura
\ref{fig:partition_cell}

\begin{figure}[h!]
  \centering
    \includegraphics[keepaspectratio=true,width=0.9\textwidth]
      {images/hist_cell.jpg}
    \caption{Representação da partição em células. Fonte:Gil's CV blog,
      disponível em:
        <https://gilscvblog.wordpress.com/2013/08/18/a-short-introduction-to-descriptors/>
          Acesso em jun. 2015.}
  \label{fig:partition_cell}
\end{figure}

As classes do histograma
representam faixas de ângulos da orientação do gradiente e são ponderadas pela
magnitude dos mesmos. Para evitar artefatos de quantização no histograma
obtido, cada gradiente é dividido entre as duas classes cujo limiar é o mais
próximo do ângulo do gradiente, ponderando pela diferença entre o ângulo do 
gradiente e o limiar. 

A figura \ref{fig:histogram} e as equações
\ref{eq:delta_theta}, \ref{eq:c1}, \ref{eq:c2}, \ref{eq:mod_c} e 
\ref{eq:limiar} 
demonstram as relações entre o vetor gradiente de
um \emph{pixel} e o valor adicionado no histograma. 

\begin{figure}[h!]
  \centering
    \includegraphics[keepaspectratio=true,width=0.9\textwidth]
      {images/polar_hist.png}
    \caption{À esquerda a representação cartesiana e polar do gradiente. À
      direita representado o histograma e os valores somados a ele por esse
        gradiente.}
\label{fig:histogram}
\end{figure}

\begin{equation} \label{eq:mod_c}
{|C|} = {{2 \pi} \over {n}}
\end{equation}

Sendo \(|C|\) a largura da faixa de valores de uma classe do histograma e $n$ o
número de classes do histograma.

\begin{equation} \label{eq:limiar}
  \theta_{limiar} = \left\lceil {{I_{\theta}} \over {|C|}} - 0.5 \right\rceil
  \cdot |C|
\end{equation}

Sendo $\theta_{limiar}$ o valor de ângulo limiar que divide as duas classes nas
quais o gradiente será dividido.

\begin{equation} \label{eq:delta_theta}
  \Delta \theta = {I_{\theta} - \theta_{limiar}}
\end{equation}

\begin{equation} \label{eq:c1}
  C_1 = \left( 0.5 - {{\Delta \theta} \over {|C|}}\right) \cdot I_{\rho}
\end{equation}

\begin{equation} \label{eq:c2}
  C_2 = \left( 0.5 + {{\Delta \theta} \over {|C|}}\right) \cdot I_{\rho}
\end{equation}

Sendo $C_1$ e $C_2$ os valores adicionados nas duas classes do histograma.

As posições de $C_1$ e $C_2$ podem ser calculadas em tempo constante através
das equações \ref{eq:p_c1} e \ref{eq:p_c2}.

\begin{equation} \label{eq:p_c1}
id(C_1) = 
\left\lfloor {{I_{\theta} - \left( {{|C|} \over {2}} \right)} \over {|C|}} 
\right\rfloor \bmod n
\end{equation}

\begin{equation} \label{eq:p_c2}
id(C_2) = \left( id (C_1) + 1 \right) \bmod n
\end{equation}

Se o valor de \(I_{\phi}\) for menor do que \(\theta_{limiar}\), o valor de
\(\Delta \theta\) vai ser negativo e a maior parte do gradiente vai ser
colocada na classe \(C_1\). Caso contrário, a maior parte na classe \(C_2\).
O valor de \(\Delta \theta\) sempre vai estar entre -0.5 e +0.5, senão o limiar 
mais próximo estaria entre outras duas classes. Os valores \(C_1\) e \(C_2\)
  será adicionado nas duas classes do histograma.

Cada histograma obtido é normalizado, e depois eles são agrupados em blocos de 
tamanho fixo. O agrupamento em blocos funciona como uma janela deslizante sobre
as células, com cada histograma calculado possivelmente aparecendo
múltiplas vezes no descritor final. TODO: colocar imagem para demonstrar o
agrupamento em blocos. Dentro de cada bloco, os histogramas correspondentes são 
concatenados e normalizados novamente. O descritor final é a concatenação do
resultado de cada bloco, resultando em um vetor de \emph{número de blocos
  \(\times\) 
número de células por bloco \(\times\) número de classes do histograma} 
dimensões. Para a detecção de pessoas, em \cite{dalal2005histograms}, foram
usados $105$ blocos, com $4$ blocos por célula, e um histograma de $9$ classes,
       totalizando em $105 \times 4 \times 9 = 3780$ características.


