\chapter{Organização da biblioteca}

O mpetodo HOG foi implementado em uma biblioteca, de maneira a 
facilitar a utilização em projetos futuros. Foram incluídas na biblioteca uma
implementação em GPU e outra em CPU, com uma interface comum.

No restante deste capítulo primeiramente serão apresentadas as ferramentas de
\emph{software} e \emph{hardware} utilizadas, assim como a 
organização da biblioteca. Após isso, o capítulo traz
uma documentação breve de cada um
dos módulos. 

\section{Ferramentas utilizadas}

\subsection{Kit de desenvolvimento Jetson TK1}

A placa embarcada Jetson TK1, produzida pela NVidia, foi escolhida para o
projeto devido ao seu poder de processamento, baixo consumo e custo 
relativamente baixo se comparado com as alternativas disponíveis no
mercado.

A placa utiliza o \sigla{SoC}{System on Chip}(\emph{System on Chip}) Tegra K1,
um processador de 4 núcleos ARM Cortex A15, e possui uma GPU integrada com a
arquitetura Kepler contendo 192 cores CUDA separados fisicamente em três blocos.
Cada bloco tem sua própria cache, que é compartilhada entre seus 64 cores e pode
ser utilizada para sincronizar as \emph{threads} em execução. A placa possui uma
memória RAM de 2GB com largura de 64 bits, sendo ela compartilhada entre a
CPU e a GPU, não sendo necessário copiar os dados entre as partes, diferente de
uma GPU discreta que possui sua própria memória dedicada separada da CPU. A
memória é grande o suficiente para nos permitir trabalhar com imagem e vídeo.

Juntamente com a placa, foi utilizado o ambiente de desenvolvimento NSight
Eclipse Edition da NVidia, uma versão modificada do Eclipse, preparada para
compliação de código CUDA.

\subsection{OpenCV}

OpenCV\footnote{http://opencv.org} é uma biblioteca de código aberto para aplicações 
  de processamento de
imagem. A biblioteca é disponibilizada gratuitamente e recebe suporte por parte
de sua comunidade. Ela possui um módulo com algumas funcionalidades
implementadas para aplicações em GPU, e
a NVidia disponibiliza uma versão compilada com otimizações especifícas para o 
processador Tegra K1, como parte do \emph{framework} CUDA.

Foi utilizada a versão 2.4.9 da biblioteca para desenvolvimento e a versão
otimizada da NVidia para execução no processador Tegra K1.

\subsection{TinyXML-2}

Para realizar a permanência de configuração do sistema, foi utilizada a 
biblioteca TinyXML-2\footnote{http://grinninglizard.com/tinyxml2}, incluída
como dois arquivos-fonte no projeto.

\subsection{Boost}

Alguns detalhes de implementação foram supridos pelo uso de algumas bibliotecas
do conjunto de bibliotecas Boost\footnote{http://boost.org}. Mais
especificamente, foram usadas as bibliotecas \emph{thread}, \emph{chrono},
  \emph{random} e \emph{filesystem} para, respectivamente, fazer chamadas
  assíncronas de função, medir o tempo de execução de trechos de código,
  geração eficiente de números aleatórios e automatização de acesso aos
  arquivos do sistema para realização dos testes.

\subsection{GitHub}

Foi utilizada a plataforma GitHub para realizar o versionamento de código do
projeto. A biblioteca pode ser encontrada em: 
<https://github.com/EAPVA/GHoGLib>, o código usado para testes em
<https://github.com/EAPVA/GHoGLib\_Tests> e um código de exemplo utilizando a
biblioteca em <https://github.com/EAPVA/GHoGLib\_Example>.

\section{Organização da biblioteca}

A biblioteca possui as seguintes classes e interfaces:

\begin{itemize}
  \item \textbf{HogDescriptor} - Implementação na CPU do HOG.
  \item \textbf{HogGPU} - Implementação na GPU do HOG, é uma subclasse de
  HogDescriptor.
  \item \textbf{Settings} - Funcionalidade de permanência de parâmetros de
  configuração.
  \item \textbf{Utils} - Classe estática com métodos utilitários.
  \item \textbf{IClassifier} - Interface para implementar um classificador.
  Para ser utilizada em trabalhos futuros.
\end{itemize}

Além disso, a biblioteca possui dois \emph{headers} especiais:

\begin{itemize}
  \item \textbf{HogCallbacks.inc} - Possui métodos de \emph{callback}
  para serem usados
  nos métodos assíncronos.
  \item \textbf{GHoGLibConstants.inc} - Contém constantes usadas no sistema.
\end{itemize}

A implementação da classe HogGPU está dividida em quatro arquivos:

\begin{itemize}
  \item \textbf{HogGPU.h} - Possui a definição da classe
  \item \textbf{HogGPU.cu} - Possui a implementação da parte \emph{host} da
  classe.
  \item \textbf{HogGPU\_impl.cuh} - Define as funções \emph{kernel} usadas na
  classe.
  \item \textbf{HogGPU\_imph.cu} - Implementa as funções \emph{kernel} usadas.
\end{itemize}

\subsection{Hog Callbacks}

Algumas classes de \emph{callback} são definidas para serem utilizadas em
métodos assíncronos:

\begin{itemize}
  \item \textbf{ImageCallback} - Retorna uma image processada.
  \item \textbf{GradientCallback} - Retorna duas matrizes, uma com as
  magnitudes dos gradientes e outra com as orientações.
  \item \textbf{DescriptorCallback} - Retorna um vetor conténdo o descritor
  de características.
  \item \textbf{ClassifyCallback} - Retorna o resultado de uma classificação
  (se a região de uma imagem pertence ou não a uma classe.) Para ser usado em
  trabalhos futuros.
  \item \textbf{LocateCallback} - Retorna uma lista de retângulos de objetos
  indentificados em uma imagem. Para ser usado em trabalhos futuros.
\end{itemize}

\section{Descrição da biblioteca}

Foi dada preferência pela utilização de \emph{containers} do OpenCV, de maneira
a facilitar a integração com o OpenCV em trabalhos futuros.

\subsection{Enumerações}

\subsubsection{GHOG\_LIB\_STATUS}

Define os códigos de erro usados na biblioteca.

\begin{itemize}
  \item \textbf{GHOG\_LIB\_STATUS\_OK} - Nenhum erro ocorreu.
  \item \textbf{GHOG\_LIB\_STATUS\_INVALID\_PARAMETER\_NAME} - Foi realizada a
  leitura ou gravação de um parâmetro inexistente.
  \item \textbf{GHOG\_LIB\_STATUS\_UNKNOWN\_ERROR} - Um erro desconhecido ocorreu.
\end{itemize}

\subsection{Classes}

\subsubsection{HogDescriptor}

Uma das classes principais do sistema, fornece as funcionalidades usadas para o
cálculo do descritor, permite configurar o algoritmo, e fornece algumas funções
para facilitar as tarefas de classificação e descrição, caso seja fornecido um
classificador. A classe HogGPU é subclasse desta, sobrescrevendo apenas os 
métodos que usam a GPU, de maneira a evitar duplicação de código.

A seguir uma breve descrição de cada um dos métodos públicos da classe.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=29, lastline=31, style=customc]
  {ghogsrc/HogDescriptor.h}

Reserva uma região de memória para ser usada pela biblioteca. Não possui muita
utilidade para a implementação em CPU.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=33, lastline=36, style=customc]
  {ghogsrc/HogDescriptor.h}

Versões assíncrona e síncrona para realizar a normalização da imagem.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=38, lastline=45, style=customc]
  {ghogsrc/HogDescriptor.h}

Versões assíncrona e síncrona para calcular a magnitude e a
orientação de gradiente da imagem.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=47, lastline=54, style=customc]
  {ghogsrc/HogDescriptor.h}

Versões assíncrona e síncrona para obter o descritor a partir dos
gradientes.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=56, lastline=59, style=customc]
  {ghogsrc/HogDescriptor.h}

Versões assíncrona e síncrona para realizar a classificação de uma
imagem. Chama os três métodos acima (normalização, cálculo de gradientes e
                                     cálculo do descritor), passando o
resultado para o classificador. 
Requer que um classificador tenha sido passado para a classe e treinado.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=61, lastline=70, style=customc]
  {ghogsrc/HogDescriptor.h}

Versões assíncrona e síncrona para localizar objetos de interesse em uma
imagem. Não implementado no momento.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=72, lastline=72, style=customc]
  {ghogsrc/HogDescriptor.h}

Carrega configurações a partir de um arquivo \sigla{XML}{Extensible Markup
  Language}(\emph{Extensible Markup Language} - Linguagem de marcação
            extendível).

\vspace{7mm}

\lstinputlisting[language=C++, firstline=74, lastline=74, style=customc]
  {ghogsrc/HogDescriptor.h}

Muda o classificador utilizado.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=76, lastline=78, style=customc]
  {ghogsrc/HogDescriptor.h}

Respectivamente modifica e lê configurações da biblioteca.

\subsubsection{HogGPU}

A classe reimplementa alguns métodos da HogDescriptor. Detalhes sobre a
implementação são discutidas no próximo capítulo.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=29, lastline=31, style=customc]
  {ghogsrc/HogGPU.h}

Reserva uma região de memória compartilhada entre a GPU e a CPU.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=33, lastline=51, style=customc]
  {ghogsrc/HogGPU.h}

Reimplementação das funções de normalização, cálculo de gradientes e geração
dos descritores. Chamam funções \emph{kernel} implementadas no arquivo
HogHPU\_impl.cu.

\subsubsection{HogGPU\_impl.cu}

Nesse arquivo estão implementados os métodos \emph{kernel} chamados pela 
classe HogGPU.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=11, lastline=14, style=customc]
  {ghogsrc/HogGPU_impl.cuh}

Cada bloco de \emph{threads} calcula a normalização de até $64$
\emph{pixels} de uma linha da imagem de entrada.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=16, lastline=23, style=customc]
  {ghogsrc/HogGPU_impl.cuh}

Cada bloco de \emph{threads} calcula o gradiente de maior magnitude de
até $64$ \emph{pixels} de uma linha da imagem de entrada.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=25, lastline=35, style=customc]
  {ghogsrc/HogGPU_impl.cuh}

Cada bloco de \emph{threads} calcula, para $64$ \emph{pixels} de uma linha da 
imagem de entrada, a soma parcial dos histogramas correspondentes a esses
\emph{pixels}. Essa divisão foi feita dessa maneira para otimizar o acesso à
memória global.
  
\vspace{7mm}

\lstinputlisting[language=C++, firstline=11, lastline=14, style=customc]
  {ghogsrc/HogGPU_impl.cuh}

Cada bloco de \emph{threads} realiza o agrupamento e normalização de até 8
blocos do descritor, em uma linha de blocos (ou seja, ele não pega mais do que
                                             uma linha de blocos da malha).

\subsubsection{Settings}

Possui métodos para ler e escrever parâmetros de ocnfiguração do sistema em um
arquivo XML, usando a biblioteca TinyXML para isso.

\subsubsection{Utils}

Criada para conter funções estáticas de utilidade para o sistema. No momento só
possui um método, para fazer divisões entre números com duas dimensões:

\lstinputlisting[language=C++, firstline=25, lastline=26, style=customc]
  {ghogsrc/Utils.h}

O resultado dessa operação é $\left({{a_1} \over {a_2}}, {{b_1} \over
                                    {b_2}}\right)$,
  sendo $(a_1, b_1)$ o numerador e $(a_2,b_2)$ o denominador.

\subsubsection{IClassifier}

Uma interface para uma classe capaz de realizar a tarefa de classificação de um
descritor de características. Define duas classes de \emph{callback}, para
serem usadas em métodos assíncronos:

\vspace{7mm}

\lstinputlisting[language=C++, firstline=22, lastline=35, style=customc]
  {ghogsrc/IClassifier.h}

\vspace{7mm}

Além disso, define os seguintes métodos:

\vspace{7mm}

\lstinputlisting[language=C++, firstline=44, lastline=48, style=customc]
  {ghogsrc/IClassifier.h}

  Versão assíncrona e síncrona para realizar o treinamento. O parâmetro 
  \emph{train\_data} é uma matriz onde cada linha representa a entrada de uma
  instância de treinamento e o parâmetro \emph{expected\_outputs} é um vetor
  com cada elemento sendo a saída esperada correspondente a uma das entradas.

\vspace{7mm}

\lstinputlisting[language=C++, firstline=50, lastline=52, style=customc]
  {ghogsrc/IClassifier.h}

Versão assíncrona e síncrona para realizar a classificação. O parâmetro
\emph{input} é um vetor contendo o descritor a ser classificado e a função
retorna um vetor resultante, para o caso de classificadores que retornam um
resultado multidimensional (como, por exemplo, redes neurais).

\vspace{7mm}

\lstinputlisting[language=C++, firstline=54, lastline=59, style=customc]
  {ghogsrc/IClassifier.h}

Métodos para fazer a permanência de configuração e do treinamento do
classificador.

